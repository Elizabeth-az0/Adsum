var Et=Object.defineProperty;var c=(e,t)=>Et(e,"name",{value:t,configurable:!0});var ee=c((e,t,r)=>(s,n)=>{let i=-1;return o(0);async function o(u){if(u<=i)throw new Error("next() called multiple times");i=u;let a,l=!1,h;if(e[u]?(h=e[u][0][0],s.req.routeIndex=u):h=u===e.length&&n||void 0,h)try{a=await h(s,()=>o(u+1))}catch(d){if(d instanceof Error&&t)s.error=d,a=await t(d,s),l=!0;else throw d}else s.finalized===!1&&r&&(a=await r(s));return a&&(s.finalized===!1||l)&&(s.res=a),s}},"compose");var Pe=Symbol();var Te=c(async(e,t=Object.create(null))=>{let{all:r=!1,dot:s=!1}=t,i=(e instanceof B?e.raw.headers:e.headers).get("Content-Type");return i?.startsWith("multipart/form-data")||i?.startsWith("application/x-www-form-urlencoded")?yt(e,{all:r,dot:s}):{}},"parseBody");async function yt(e,t){let r=await e.formData();return r?St(r,t):{}}c(yt,"parseFormData");function St(e,t){let r=Object.create(null);return e.forEach((s,n)=>{t.all||n.endsWith("[]")?vt(r,n,s):r[n]=s}),t.dot&&Object.entries(r).forEach(([s,n])=>{s.includes(".")&&(Rt(r,s,n),delete r[s])}),r}c(St,"convertFormDataToBodyData");var vt=c((e,t,r)=>{e[t]!==void 0?Array.isArray(e[t])?e[t].push(r):e[t]=[e[t],r]:t.endsWith("[]")?e[t]=[r]:e[t]=r},"handleParsingAllValues"),Rt=c((e,t,r)=>{let s=e,n=t.split(".");n.forEach((i,o)=>{o===n.length-1?s[i]=r:((!s[i]||typeof s[i]!="object"||Array.isArray(s[i])||s[i]instanceof File)&&(s[i]=Object.create(null)),s=s[i])})},"handleParsingNestedValues");var re=c(e=>{let t=e.split("/");return t[0]===""&&t.shift(),t},"splitPath"),He=c(e=>{let{groups:t,path:r}=bt(e),s=re(r);return At(s,t)},"splitRoutingPath"),bt=c(e=>{let t=[];return e=e.replace(/\{[^}]+\}/g,(r,s)=>{let n=`@${s}`;return t.push([n,r]),n}),{groups:t,path:e}},"extractGroupsFromPath"),At=c((e,t)=>{for(let r=t.length-1;r>=0;r--){let[s]=t[r];for(let n=e.length-1;n>=0;n--)if(e[n].includes(s)){e[n]=e[n].replace(s,t[r][1]);break}}return e},"replaceGroupMarks"),q={},Ce=c((e,t)=>{if(e==="*")return"*";let r=e.match(/^\:([^\{\}]+)(?:\{(.+)\})?$/);if(r){let s=`${e}#${t}`;return q[s]||(r[2]?q[s]=t&&t[0]!==":"&&t[0]!=="*"?[s,r[1],new RegExp(`^${r[2]}(?=/${t})`)]:[e,r[1],new RegExp(`^${r[2]}$`)]:q[s]=[e,r[1],!0]),q[s]}return null},"getPattern"),k=c((e,t)=>{try{return t(e)}catch{return e.replace(/(?:%[0-9A-Fa-f]{2})+/g,r=>{try{return t(r)}catch{return r}})}},"tryDecode"),xt=c(e=>k(e,decodeURI),"tryDecodeURI"),se=c(e=>{let t=e.url,r=t.indexOf("/",t.indexOf(":")+4),s=r;for(;s<t.length;s++){let n=t.charCodeAt(s);if(n===37){let i=t.indexOf("?",s),o=t.indexOf("#",s),u=i===-1?o===-1?void 0:o:o===-1?i:Math.min(i,o),a=t.slice(r,u);return xt(a.includes("%25")?a.replace(/%25/g,"%2525"):a)}else if(n===63||n===35)break}return t.slice(r,s)},"getPath");var _e=c(e=>{let t=se(e);return t.length>1&&t.at(-1)==="/"?t.slice(0,-1):t},"getPathNoStrict"),A=c((e,t,...r)=>(r.length&&(t=A(t,...r)),`${e?.[0]==="/"?"":"/"}${e}${t==="/"?"":`${e?.at(-1)==="/"?"":"/"}${t?.[0]==="/"?t.slice(1):t}`}`),"mergePath"),U=c(e=>{if(e.charCodeAt(e.length-1)!==63||!e.includes(":"))return null;let t=e.split("/"),r=[],s="";return t.forEach(n=>{if(n!==""&&!/\:/.test(n))s+="/"+n;else if(/\:/.test(n))if(/\?/.test(n)){r.length===0&&s===""?r.push("/"):r.push(s);let i=n.replace("?","");s+="/"+i,r.push(s)}else s+="/"+n}),r.filter((n,i,o)=>o.indexOf(n)===i)},"checkOptionalParameter"),te=c(e=>/[%+]/.test(e)?(e.indexOf("+")!==-1&&(e=e.replace(/\+/g," ")),e.indexOf("%")!==-1?k(e,F):e):e,"_decodeURI"),je=c((e,t,r)=>{let s;if(!r&&t&&!/[%+]/.test(t)){let o=e.indexOf("?",8);if(o===-1)return;for(e.startsWith(t,o+1)||(o=e.indexOf(`&${t}`,o+1));o!==-1;){let u=e.charCodeAt(o+t.length+1);if(u===61){let a=o+t.length+2,l=e.indexOf("&",a);return te(e.slice(a,l===-1?void 0:l))}else if(u==38||isNaN(u))return"";o=e.indexOf(`&${t}`,o+1)}if(s=/[%+]/.test(e),!s)return}let n={};s??=/[%+]/.test(e);let i=e.indexOf("?",8);for(;i!==-1;){let o=e.indexOf("&",i+1),u=e.indexOf("=",i);u>o&&o!==-1&&(u=-1);let a=e.slice(i+1,u===-1?o===-1?void 0:o:u);if(s&&(a=te(a)),i=o,a==="")continue;let l;u===-1?l="":(l=e.slice(u+1,o===-1?void 0:o),s&&(l=te(l))),r?(n[a]&&Array.isArray(n[a])||(n[a]=[]),n[a].push(l)):n[a]??=l}return t?n[t]:n},"_getQueryParam"),De=je,ke=c((e,t)=>je(e,t,!0),"getQueryParams"),F=decodeURIComponent;var Ne=c(e=>k(e,F),"tryDecodeURIComponent"),B=c(class{raw;#t;#e;routeIndex=0;path;bodyCache={};constructor(e,t="/",r=[[]]){this.raw=e,this.path=t,this.#e=r,this.#t={}}param(e){return e?this.#r(e):this.#i()}#r(e){let t=this.#e[0][this.routeIndex][1][e],r=this.#n(t);return r&&/\%/.test(r)?Ne(r):r}#i(){let e={},t=Object.keys(this.#e[0][this.routeIndex][1]);for(let r of t){let s=this.#n(this.#e[0][this.routeIndex][1][r]);s!==void 0&&(e[r]=/\%/.test(s)?Ne(s):s)}return e}#n(e){return this.#e[1]?this.#e[1][e]:e}query(e){return De(this.url,e)}queries(e){return ke(this.url,e)}header(e){if(e)return this.raw.headers.get(e)??void 0;let t={};return this.raw.headers.forEach((r,s)=>{t[s]=r}),t}async parseBody(e){return this.bodyCache.parsedBody??=await Te(this,e)}#s=e=>{let{bodyCache:t,raw:r}=this,s=t[e];if(s)return s;let n=Object.keys(t)[0];return n?t[n].then(i=>(n==="json"&&(i=JSON.stringify(i)),new Response(i)[e]())):t[e]=r[e]()};json(){return this.#s("text").then(e=>JSON.parse(e))}text(){return this.#s("text")}arrayBuffer(){return this.#s("arrayBuffer")}blob(){return this.#s("blob")}formData(){return this.#s("formData")}addValidatedData(e,t){this.#t[e]=t}valid(e){return this.#t[e]}get url(){return this.raw.url}get method(){return this.raw.method}get[Pe](){return this.#e}get matchedRoutes(){return this.#e[0].map(([[,e]])=>e)}get routePath(){return this.#e[0].map(([[,e]])=>e)[this.routeIndex].path}},"HonoRequest");var Ie={Stringify:1,BeforeStream:2,Stream:3},Pt=c((e,t)=>{let r=new String(e);return r.isEscaped=!0,r.callbacks=t,r},"raw");var ne=c(async(e,t,r,s,n)=>{typeof e=="object"&&!(e instanceof String)&&(e instanceof Promise||(e=e.toString()),e instanceof Promise&&(e=await e));let i=e.callbacks;if(!i?.length)return Promise.resolve(e);n?n[0]+=e:n=[e];let o=Promise.all(i.map(u=>u({phase:t,buffer:n,context:s}))).then(u=>Promise.all(u.filter(Boolean).map(a=>ne(a,t,!1,s,n))).then(()=>n[0]));return r?Pt(await o,i):o},"resolveCallback");var Tt="text/plain; charset=UTF-8",ie=c((e,t)=>({"Content-Type":e,...t}),"setDefaultContentType"),N=c((e,t)=>new Response(e,t),"createResponseInstance"),Me=c(class{#t;#e;env={};#r;finalized=!1;error;#i;#n;#s;#l;#c;#u;#a;#d;#h;constructor(e,t){this.#t=e,t&&(this.#n=t.executionCtx,this.env=t.env,this.#u=t.notFoundHandler,this.#h=t.path,this.#d=t.matchResult)}get req(){return this.#e??=new B(this.#t,this.#h,this.#d),this.#e}get event(){if(this.#n&&"respondWith"in this.#n)return this.#n;throw Error("This context has no FetchEvent")}get executionCtx(){if(this.#n)return this.#n;throw Error("This context has no ExecutionContext")}get res(){return this.#s||=N(null,{headers:this.#a??=new Headers})}set res(e){if(this.#s&&e){e=N(e.body,e);for(let[t,r]of this.#s.headers.entries())if(t!=="content-type")if(t==="set-cookie"){let s=this.#s.headers.getSetCookie();e.headers.delete("set-cookie");for(let n of s)e.headers.append("set-cookie",n)}else e.headers.set(t,r)}this.#s=e,this.finalized=!0}render=(...e)=>(this.#c??=t=>this.html(t),this.#c(...e));setLayout=e=>this.#l=e;getLayout=()=>this.#l;setRenderer=e=>{this.#c=e};header=(e,t,r)=>{this.finalized&&(this.#s=N(this.#s.body,this.#s));let s=this.#s?this.#s.headers:this.#a??=new Headers;t===void 0?s.delete(e):r?.append?s.append(e,t):s.set(e,t)};status=e=>{this.#i=e};set=(e,t)=>{this.#r??=new Map,this.#r.set(e,t)};get=e=>this.#r?this.#r.get(e):void 0;get var(){return this.#r?Object.fromEntries(this.#r):{}}#o(e,t,r){let s=this.#s?new Headers(this.#s.headers):this.#a??new Headers;if(typeof t=="object"&&"headers"in t){let i=t.headers instanceof Headers?t.headers:new Headers(t.headers);for(let[o,u]of i)o.toLowerCase()==="set-cookie"?s.append(o,u):s.set(o,u)}if(r)for(let[i,o]of Object.entries(r))if(typeof o=="string")s.set(i,o);else{s.delete(i);for(let u of o)s.append(i,u)}let n=typeof t=="number"?t:t?.status??this.#i;return N(e,{status:n,headers:s})}newResponse=(...e)=>this.#o(...e);body=(e,t,r)=>this.#o(e,t,r);text=(e,t,r)=>!this.#a&&!this.#i&&!t&&!r&&!this.finalized?new Response(e):this.#o(e,t,ie(Tt,r));json=(e,t,r)=>this.#o(JSON.stringify(e),t,ie("application/json",r));html=(e,t,r)=>{let s=c(n=>this.#o(n,t,ie("text/html; charset=UTF-8",r)),"res");return typeof e=="object"?ne(e,Ie.Stringify,!1,{}).then(s):s(e)};redirect=(e,t)=>{let r=String(e);return this.header("Location",/[^\x00-\xFF]/.test(r)?encodeURI(r):r),this.newResponse(null,t??302)};notFound=()=>(this.#u??=()=>N(),this.#u(this))},"Context");var p="ALL",Je="all",$e=["get","post","put","delete","options","patch"],K="Can not add a route since the matcher is already built.",V=c(class extends Error{},"UnsupportedPathError");var Le="__COMPOSED_HANDLER";var Ht=c(e=>e.text("404 Not Found",404),"notFoundHandler"),We=c((e,t)=>{if("getResponse"in e){let r=e.getResponse();return t.newResponse(r.body,r)}return console.error(e),t.text("Internal Server Error",500)},"errorHandler"),Be=c(class qe{get;post;put;delete;options;patch;all;on;use;router;getPath;_basePath="/";#t="/";routes=[];constructor(t={}){[...$e,Je].forEach(i=>{this[i]=(o,...u)=>(typeof o=="string"?this.#t=o:this.#i(i,this.#t,o),u.forEach(a=>{this.#i(i,this.#t,a)}),this)}),this.on=(i,o,...u)=>{for(let a of[o].flat()){this.#t=a;for(let l of[i].flat())u.map(h=>{this.#i(l.toUpperCase(),this.#t,h)})}return this},this.use=(i,...o)=>(typeof i=="string"?this.#t=i:(this.#t="*",o.unshift(i)),o.forEach(u=>{this.#i(p,this.#t,u)}),this);let{strict:s,...n}=t;Object.assign(this,n),this.getPath=s??!0?t.getPath??se:_e}#e(){let t=new qe({router:this.router,getPath:this.getPath});return t.errorHandler=this.errorHandler,t.#r=this.#r,t.routes=this.routes,t}#r=Ht;errorHandler=We;route(t,r){let s=this.basePath(t);return r.routes.map(n=>{let i;r.errorHandler===We?i=n.handler:(i=c(async(o,u)=>(await ee([],r.errorHandler)(o,()=>n.handler(o,u))).res,"handler"),i[Le]=n.handler),s.#i(n.method,n.path,i)}),this}basePath(t){let r=this.#e();return r._basePath=A(this._basePath,t),r}onError=t=>(this.errorHandler=t,this);notFound=t=>(this.#r=t,this);mount(t,r,s){let n,i;s&&(typeof s=="function"?i=s:(i=s.optionHandler,s.replaceRequest===!1?n=c(a=>a,"replaceRequest"):n=s.replaceRequest));let o=i?a=>{let l=i(a);return Array.isArray(l)?l:[l]}:a=>{let l;try{l=a.executionCtx}catch{}return[a.env,l]};n||=(()=>{let a=A(this._basePath,t),l=a==="/"?0:a.length;return h=>{let d=new URL(h.url);return d.pathname=d.pathname.slice(l)||"/",new Request(d,h)}})();let u=c(async(a,l)=>{let h=await r(n(a.req.raw),...o(a));if(h)return h;await l()},"handler");return this.#i(p,A(t,"*"),u),this}#i(t,r,s){t=t.toUpperCase(),r=A(this._basePath,r);let n={basePath:this._basePath,path:r,method:t,handler:s};this.router.add(t,r,[s,n]),this.routes.push(n)}#n(t,r){if(t instanceof Error)return this.errorHandler(t,r);throw t}#s(t,r,s,n){if(n==="HEAD")return(async()=>new Response(null,await this.#s(t,r,s,"GET")))();let i=this.getPath(t,{env:s}),o=this.router.match(n,i),u=new Me(t,{path:i,matchResult:o,env:s,executionCtx:r,notFoundHandler:this.#r});if(o[0].length===1){let l;try{l=o[0][0][0][0](u,async()=>{u.res=await this.#r(u)})}catch(h){return this.#n(h,u)}return l instanceof Promise?l.then(h=>h||(u.finalized?u.res:this.#r(u))).catch(h=>this.#n(h,u)):l??this.#r(u)}let a=ee(o[0],this.errorHandler,this.#r);return(async()=>{try{let l=await a(u);if(!l.finalized)throw new Error("Context is not finalized. Did you forget to return a Response object or `await next()`?");return l.res}catch(l){return this.#n(l,u)}})()}fetch=(t,...r)=>this.#s(t,r[1],r[0],t.method);request=(t,r,s,n)=>t instanceof Request?this.fetch(r?new Request(t,r):t,s,n):(t=t.toString(),this.fetch(new Request(/^https?:\/\//.test(t)?t:`http://localhost${A("/",t)}`,r),s,n));fire=()=>{addEventListener("fetch",t=>{t.respondWith(this.#s(t.request,t,void 0,t.request.method))})}},"_Hono");var z=[];function oe(e,t){let r=this.buildAllMatchers(),s=c((n,i)=>{let o=r[n]||r[p],u=o[2][i];if(u)return u;let a=i.match(o[0]);if(!a)return[[],z];let l=a.indexOf("",1);return[o[1][l],a]},"match2");return this.match=s,s(e,t)}c(oe,"match");var G="[^/]+",I=".*",M="(?:|/.*)",x=Symbol(),Ct=new Set(".\\+*[^]$()");function _t(e,t){return e.length===1?t.length===1?e<t?-1:1:-1:t.length===1||e===I||e===M?1:t===I||t===M?-1:e===G?1:t===G?-1:e.length===t.length?e<t?-1:1:t.length-e.length}c(_t,"compareKey");var Ue=c(class ae{#t;#e;#r=Object.create(null);insert(t,r,s,n,i){if(t.length===0){if(this.#t!==void 0)throw x;if(i)return;this.#t=r;return}let[o,...u]=t,a=o==="*"?u.length===0?["","",I]:["","",G]:o==="/*"?["","",M]:o.match(/^\:([^\{\}]+)(?:\{(.+)\})?$/),l;if(a){let h=a[1],d=a[2]||G;if(h&&a[2]&&(d===".*"||(d=d.replace(/^\((?!\?:)(?=[^)]+\)$)/,"(?:"),/\((?!\?:)/.test(d))))throw x;if(l=this.#r[d],!l){if(Object.keys(this.#r).some(f=>f!==I&&f!==M))throw x;if(i)return;l=this.#r[d]=new ae,h!==""&&(l.#e=n.varIndex++)}!i&&h!==""&&s.push([h,l.#e])}else if(l=this.#r[o],!l){if(Object.keys(this.#r).some(h=>h.length>1&&h!==I&&h!==M))throw x;if(i)return;l=this.#r[o]=new ae}l.insert(u,r,s,n,i)}buildRegExpStr(){let r=Object.keys(this.#r).sort(_t).map(s=>{let n=this.#r[s];return(typeof n.#e=="number"?`(${s})@${n.#e}`:Ct.has(s)?`\\${s}`:s)+n.buildRegExpStr()});return typeof this.#t=="number"&&r.unshift(`#${this.#t}`),r.length===0?"":r.length===1?r[0]:"(?:"+r.join("|")+")"}},"_Node");var Fe=c(class{#t={varIndex:0};#e=new Ue;insert(e,t,r){let s=[],n=[];for(let o=0;;){let u=!1;if(e=e.replace(/\{[^}]+\}/g,a=>{let l=`@\\${o}`;return n[o]=[l,a],o++,u=!0,l}),!u)break}let i=e.match(/(?::[^\/]+)|(?:\/\*$)|./g)||[];for(let o=n.length-1;o>=0;o--){let[u]=n[o];for(let a=i.length-1;a>=0;a--)if(i[a].indexOf(u)!==-1){i[a]=i[a].replace(u,n[o][1]);break}}return this.#e.insert(i,t,s,this.#t,r),s}buildRegExp(){let e=this.#e.buildRegExpStr();if(e==="")return[/^$/,[],[]];let t=0,r=[],s=[];return e=e.replace(/#(\d+)|@(\d+)|\.\*\$/g,(n,i,o)=>i!==void 0?(r[++t]=Number(i),"$()"):(o!==void 0&&(s[Number(o)]=++t),"")),[new RegExp(`^${e}`),r,s]}},"Trie");var jt=[/^$/,[],Object.create(null)],Ke=Object.create(null);function Ve(e){return Ke[e]??=new RegExp(e==="*"?"":`^${e.replace(/\/\*$|([.\\+*[^\]$()])/g,(t,r)=>r?`\\${r}`:"(?:|/.*)")}$`)}c(Ve,"buildWildcardRegExp");function Dt(){Ke=Object.create(null)}c(Dt,"clearWildcardRegExpCache");function kt(e){let t=new Fe,r=[];if(e.length===0)return jt;let s=e.map(l=>[!/\*|\/:/.test(l[0]),...l]).sort(([l,h],[d,f])=>l?1:d?-1:h.length-f.length),n=Object.create(null);for(let l=0,h=-1,d=s.length;l<d;l++){let[f,w,E]=s[l];f?n[w]=[E.map(([S])=>[S,Object.create(null)]),z]:h++;let y;try{y=t.insert(w,h,f)}catch(S){throw S===x?new V(w):S}f||(r[h]=E.map(([S,m])=>{let v=Object.create(null);for(m-=1;m>=0;m--){let[_,X]=y[m];v[_]=X}return[S,v]}))}let[i,o,u]=t.buildRegExp();for(let l=0,h=r.length;l<h;l++)for(let d=0,f=r[l].length;d<f;d++){let w=r[l][d]?.[1];if(!w)continue;let E=Object.keys(w);for(let y=0,S=E.length;y<S;y++)w[E[y]]=u[w[E[y]]]}let a=[];for(let l in o)a[l]=r[o[l]];return[i,a,n]}c(kt,"buildMatcherFromPreprocessedRoutes");function H(e,t){if(e){for(let r of Object.keys(e).sort((s,n)=>n.length-s.length))if(Ve(r).test(t))return[...e[r]]}}c(H,"findMiddleware");var Q=c(class{name="RegExpRouter";#t;#e;constructor(){this.#t={[p]:Object.create(null)},this.#e={[p]:Object.create(null)}}add(e,t,r){let s=this.#t,n=this.#e;if(!s||!n)throw new Error(K);s[e]||[s,n].forEach(u=>{u[e]=Object.create(null),Object.keys(u[p]).forEach(a=>{u[e][a]=[...u[p][a]]})}),t==="/*"&&(t="*");let i=(t.match(/\/:/g)||[]).length;if(/\*$/.test(t)){let u=Ve(t);e===p?Object.keys(s).forEach(a=>{s[a][t]||=H(s[a],t)||H(s[p],t)||[]}):s[e][t]||=H(s[e],t)||H(s[p],t)||[],Object.keys(s).forEach(a=>{(e===p||e===a)&&Object.keys(s[a]).forEach(l=>{u.test(l)&&s[a][l].push([r,i])})}),Object.keys(n).forEach(a=>{(e===p||e===a)&&Object.keys(n[a]).forEach(l=>u.test(l)&&n[a][l].push([r,i]))});return}let o=U(t)||[t];for(let u=0,a=o.length;u<a;u++){let l=o[u];Object.keys(n).forEach(h=>{(e===p||e===h)&&(n[h][l]||=[...H(s[h],l)||H(s[p],l)||[]],n[h][l].push([r,i-a+u+1]))})}}match=oe;buildAllMatchers(){let e=Object.create(null);return Object.keys(this.#e).concat(Object.keys(this.#t)).forEach(t=>{e[t]||=this.#r(t)}),this.#t=this.#e=void 0,Dt(),e}#r(e){let t=[],r=e===p;return[this.#t,this.#e].forEach(s=>{let n=s[e]?Object.keys(s[e]).map(i=>[i,s[e][i]]):[];n.length!==0?(r||=!0,t.push(...n)):e!==p&&t.push(...Object.keys(s[p]).map(i=>[i,s[p][i]]))}),r?kt(t):null}},"RegExpRouter");var ce=c(class{name="SmartRouter";#t=[];#e=[];constructor(e){this.#t=e.routers}add(e,t,r){if(!this.#e)throw new Error(K);this.#e.push([e,t,r])}match(e,t){if(!this.#e)throw new Error("Fatal error");let r=this.#t,s=this.#e,n=r.length,i=0,o;for(;i<n;i++){let u=r[i];try{for(let a=0,l=s.length;a<l;a++)u.add(...s[a]);o=u.match(e,t)}catch(a){if(a instanceof V)continue;throw a}this.match=u.match.bind(u),this.#t=[u],this.#e=void 0;break}if(i===n)throw new Error("Fatal error");return this.name=`SmartRouter + ${this.activeRouter.name}`,o}get activeRouter(){if(this.#e||this.#t.length!==1)throw new Error("No active router has been determined yet.");return this.#t[0]}},"SmartRouter");var J=Object.create(null),Nt=c(e=>{for(let t in e)return!0;return!1},"hasChildren"),ze=c(class Ge{#t;#e;#r;#i=0;#n=J;constructor(t,r,s){if(this.#e=s||Object.create(null),this.#t=[],t&&r){let n=Object.create(null);n[t]={handler:r,possibleKeys:[],score:0},this.#t=[n]}this.#r=[]}insert(t,r,s){this.#i=++this.#i;let n=this,i=He(r),o=[];for(let u=0,a=i.length;u<a;u++){let l=i[u],h=i[u+1],d=Ce(l,h),f=Array.isArray(d)?d[0]:l;if(f in n.#e){n=n.#e[f],d&&o.push(d[1]);continue}n.#e[f]=new Ge,d&&(n.#r.push(d),o.push(d[1])),n=n.#e[f]}return n.#t.push({[t]:{handler:s,possibleKeys:o.filter((u,a,l)=>l.indexOf(u)===a),score:this.#i}}),n}#s(t,r,s,n,i){for(let o=0,u=r.#t.length;o<u;o++){let a=r.#t[o],l=a[s]||a[p],h={};if(l!==void 0&&(l.params=Object.create(null),t.push(l),n!==J||i&&i!==J))for(let d=0,f=l.possibleKeys.length;d<f;d++){let w=l.possibleKeys[d],E=h[l.score];l.params[w]=i?.[w]&&!E?i[w]:n[w]??i?.[w],h[l.score]=!0}}}search(t,r){let s=[];this.#n=J;let i=[this],o=re(r),u=[],a=o.length,l=null;for(let h=0;h<a;h++){let d=o[h],f=h===a-1,w=[];for(let y=0,S=i.length;y<S;y++){let m=i[y],v=m.#e[d];v&&(v.#n=m.#n,f?(v.#e["*"]&&this.#s(s,v.#e["*"],t,m.#n),this.#s(s,v,t,m.#n)):w.push(v));for(let _=0,X=m.#r.length;_<X;_++){let xe=m.#r[_],b=m.#n===J?{}:{...m.#n};if(xe==="*"){let T=m.#e["*"];T&&(this.#s(s,T,t,m.#n),T.#n=b,w.push(T));continue}let[gt,Oe,j]=xe;if(!d&&!(j instanceof RegExp))continue;let R=m.#e[gt];if(j instanceof RegExp){if(l===null){l=new Array(a);let W=r[0]==="/"?1:0;for(let D=0;D<a;D++)l[D]=W,W+=o[D].length+1}let T=r.substring(l[h]),Z=j.exec(T);if(Z){if(b[Oe]=Z[0],this.#s(s,R,t,m.#n,b),Nt(R.#e)){R.#n=b;let W=Z[0].match(/\//)?.length??0;(u[W]||=[]).push(R)}continue}}(j===!0||j.test(d))&&(b[Oe]=d,f?(this.#s(s,R,t,b,m.#n),R.#e["*"]&&this.#s(s,R.#e["*"],t,b,m.#n)):(R.#n=b,w.push(R)))}}let E=u.shift();i=E?w.concat(E):w}return s.length>1&&s.sort((h,d)=>h.score-d.score),[s.map(({handler:h,params:d})=>[h,d])]}},"_Node");var ue=c(class{name="TrieRouter";#t;constructor(){this.#t=new ze}add(e,t,r){let s=U(t);if(s){for(let n=0,i=s.length;n<i;n++)this.#t.insert(e,s[n],r);return}this.#t.insert(e,t,r)}match(e,t){return this.#t.search(e,t)}},"TrieRouter");var le=c(class extends Be{constructor(e={}){super(e),this.router=e.router??new ce({routers:[new Q,new ue]})}},"Hono");var Qe=c(e=>{let r={...{origin:"*",allowMethods:["GET","HEAD","PUT","POST","DELETE","PATCH"],allowHeaders:[],exposeHeaders:[]},...e},s=(i=>typeof i=="string"?i==="*"?()=>i:o=>i===o?o:null:typeof i=="function"?i:o=>i.includes(o)?o:null)(r.origin),n=(i=>typeof i=="function"?i:Array.isArray(i)?()=>i:()=>[])(r.allowMethods);return c(async function(o,u){function a(h,d){o.res.headers.set(h,d)}c(a,"set");let l=await s(o.req.header("origin")||"",o);if(l&&a("Access-Control-Allow-Origin",l),r.credentials&&a("Access-Control-Allow-Credentials","true"),r.exposeHeaders?.length&&a("Access-Control-Expose-Headers",r.exposeHeaders.join(",")),o.req.method==="OPTIONS"){r.origin!=="*"&&a("Vary","Origin"),r.maxAge!=null&&a("Access-Control-Max-Age",r.maxAge.toString());let h=await n(o.req.header("origin")||"",o);h.length&&a("Access-Control-Allow-Methods",h.join(","));let d=r.allowHeaders;if(!d?.length){let f=o.req.header("Access-Control-Request-Headers");f&&(d=f.split(/\s*,\s*/))}return d?.length&&(a("Access-Control-Allow-Headers",d.join(",")),o.res.headers.append("Vary","Access-Control-Request-Headers")),o.res.headers.delete("Content-Length"),o.res.headers.delete("Content-Type"),new Response(null,{headers:o.res.headers,status:204,statusText:"No Content"})}await u(),r.origin!=="*"&&o.header("Vary","Origin",{append:!0})},"cors2")},"cors");var de=c(e=>fe(e.replace(/_|-/g,t=>({_:"/","-":"+"})[t]??t)),"decodeBase64Url"),he=c(e=>It(e).replace(/\/|\+/g,t=>({"/":"_","+":"-"})[t]??t),"encodeBase64Url"),It=c(e=>{let t="",r=new Uint8Array(e);for(let s=0,n=r.length;s<n;s++)t+=String.fromCharCode(r[s]);return btoa(t)},"encodeBase64"),fe=c(e=>{let t=atob(e),r=new Uint8Array(new ArrayBuffer(t.length)),s=t.length/2;for(let n=0,i=t.length-1;n<=s;n++,i--)r[n]=t.charCodeAt(n),r[i]=t.charCodeAt(i);return r},"decodeBase64");var O=(e=>(e.HS256="HS256",e.HS384="HS384",e.HS512="HS512",e.RS256="RS256",e.RS384="RS384",e.RS512="RS512",e.PS256="PS256",e.PS384="PS384",e.PS512="PS512",e.ES256="ES256",e.ES384="ES384",e.ES512="ES512",e.EdDSA="EdDSA",e))(O||{});var Mt={deno:"Deno",bun:"Bun",workerd:"Cloudflare-Workers",node:"Node.js"},Ye=c(()=>{let e=globalThis;if(typeof navigator<"u"&&!0){for(let[r,s]of Object.entries(Mt))if(Jt(s))return r}return typeof e?.EdgeRuntime=="string"?"edge-light":e?.fastly!==void 0?"fastly":e?.process?.release?.name==="node"?"node":"other"},"getRuntimeKey"),Jt=c(e=>"Cloudflare-Workers".startsWith(e),"checkUserAgentEquals");var Xe=c(class extends Error{constructor(e){super(`${e} is not an implemented algorithm`),this.name="JwtAlgorithmNotImplemented"}},"JwtAlgorithmNotImplemented"),pe=c(class extends Error{constructor(){super('JWT verification requires "alg" option to be specified'),this.name="JwtAlgorithmRequired"}},"JwtAlgorithmRequired"),me=c(class extends Error{constructor(e,t){super(`JWT algorithm mismatch: expected "${e}", got "${t}"`),this.name="JwtAlgorithmMismatch"}},"JwtAlgorithmMismatch"),$=c(class extends Error{constructor(e){super(`invalid JWT token: ${e}`),this.name="JwtTokenInvalid"}},"JwtTokenInvalid"),Ze=c(class extends Error{constructor(e){super(`token (${e}) is being used before it's valid`),this.name="JwtTokenNotBefore"}},"JwtTokenNotBefore"),et=c(class extends Error{constructor(e){super(`token (${e}) expired`),this.name="JwtTokenExpired"}},"JwtTokenExpired"),tt=c(class extends Error{constructor(e,t){super(`Invalid "iat" claim, must be a valid number lower than "${e}" (iat: "${t}")`),this.name="JwtTokenIssuedAt"}},"JwtTokenIssuedAt"),Y=c(class extends Error{constructor(e,t){super(`expected issuer "${e}", got ${t?`"${t}"`:"none"} `),this.name="JwtTokenIssuer"}},"JwtTokenIssuer"),we=c(class extends Error{constructor(e){super(`jwt header is invalid: ${JSON.stringify(e)}`),this.name="JwtHeaderInvalid"}},"JwtHeaderInvalid"),rt=c(class extends Error{constructor(e){super(`required "kid" in jwt header: ${JSON.stringify(e)}`),this.name="JwtHeaderRequiresKid"}},"JwtHeaderRequiresKid"),st=c(class extends Error{constructor(e){super(`symmetric algorithm "${e}" is not allowed for JWK verification`),this.name="JwtSymmetricAlgorithmNotAllowed"}},"JwtSymmetricAlgorithmNotAllowed"),nt=c(class extends Error{constructor(e,t){super(`algorithm "${e}" is not in the allowed list: [${t.join(", ")}]`),this.name="JwtAlgorithmNotAllowed"}},"JwtAlgorithmNotAllowed"),it=c(class extends Error{constructor(e){super(`token(${e}) signature mismatched`),this.name="JwtTokenSignatureMismatched"}},"JwtTokenSignatureMismatched"),ot=c(class extends Error{constructor(e){super(`required "aud" in jwt payload: ${JSON.stringify(e)}`),this.name="JwtPayloadRequiresAud"}},"JwtPayloadRequiresAud"),at=c(class extends Error{constructor(e,t){super(`expected audience "${Array.isArray(e)?e.join(", "):e}", got "${t}"`),this.name="JwtTokenAudience"}},"JwtTokenAudience"),C=(e=>(e.Encrypt="encrypt",e.Decrypt="decrypt",e.Sign="sign",e.Verify="verify",e.DeriveKey="deriveKey",e.DeriveBits="deriveBits",e.WrapKey="wrapKey",e.UnwrapKey="unwrapKey",e))(C||{});var P=new TextEncoder,ct=new TextDecoder;async function lt(e,t,r){let s=ht(t),n=await $t(e,s);return await crypto.subtle.sign(s,n,r)}c(lt,"signing");async function dt(e,t,r,s){let n=ht(t),i=await Lt(e,n);return await crypto.subtle.verify(n,i,r,s)}c(dt,"verifying");function ge(e){return fe(e.replace(/-+(BEGIN|END).*/g,"").replace(/\s/g,""))}c(ge,"pemToBinary");async function $t(e,t){if(!crypto.subtle||!crypto.subtle.importKey)throw new Error("`crypto.subtle.importKey` is undefined. JWT auth middleware requires it.");if(ft(e)){if(e.type!=="private"&&e.type!=="secret")throw new Error(`unexpected key type: CryptoKey.type is ${e.type}, expected private or secret`);return e}let r=[C.Sign];return typeof e=="object"?await crypto.subtle.importKey("jwk",e,t,!1,r):e.includes("PRIVATE")?await crypto.subtle.importKey("pkcs8",ge(e),t,!1,r):await crypto.subtle.importKey("raw",P.encode(e),t,!1,r)}c($t,"importPrivateKey");async function Lt(e,t){if(!crypto.subtle||!crypto.subtle.importKey)throw new Error("`crypto.subtle.importKey` is undefined. JWT auth middleware requires it.");if(ft(e)){if(e.type==="public"||e.type==="secret")return e;e=await ut(e)}if(typeof e=="string"&&e.includes("PRIVATE")){let s=await crypto.subtle.importKey("pkcs8",ge(e),t,!0,[C.Sign]);e=await ut(s)}let r=[C.Verify];return typeof e=="object"?await crypto.subtle.importKey("jwk",e,t,!1,r):e.includes("PUBLIC")?await crypto.subtle.importKey("spki",ge(e),t,!1,r):await crypto.subtle.importKey("raw",P.encode(e),t,!1,r)}c(Lt,"importPublicKey");async function ut(e){if(e.type!=="private")throw new Error(`unexpected key type: ${e.type}`);if(!e.extractable)throw new Error("unexpected private key is unextractable");let t=await crypto.subtle.exportKey("jwk",e),{kty:r}=t,{alg:s,e:n,n:i}=t,{crv:o,x:u,y:a}=t;return{kty:r,alg:s,e:n,n:i,crv:o,x:u,y:a,key_ops:[C.Verify]}}c(ut,"exportPublicJwkFrom");function ht(e){switch(e){case"HS256":return{name:"HMAC",hash:{name:"SHA-256"}};case"HS384":return{name:"HMAC",hash:{name:"SHA-384"}};case"HS512":return{name:"HMAC",hash:{name:"SHA-512"}};case"RS256":return{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}};case"RS384":return{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-384"}};case"RS512":return{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-512"}};case"PS256":return{name:"RSA-PSS",hash:{name:"SHA-256"},saltLength:32};case"PS384":return{name:"RSA-PSS",hash:{name:"SHA-384"},saltLength:48};case"PS512":return{name:"RSA-PSS",hash:{name:"SHA-512"},saltLength:64};case"ES256":return{name:"ECDSA",hash:{name:"SHA-256"},namedCurve:"P-256"};case"ES384":return{name:"ECDSA",hash:{name:"SHA-384"},namedCurve:"P-384"};case"ES512":return{name:"ECDSA",hash:{name:"SHA-512"},namedCurve:"P-521"};case"EdDSA":return{name:"Ed25519",namedCurve:"Ed25519"};default:throw new Xe(e)}}c(ht,"getKeyAlgorithm");function ft(e){return Ye()==="node"&&crypto.webcrypto?e instanceof crypto.webcrypto.CryptoKey:e instanceof CryptoKey}c(ft,"isCryptoKey");var Ee=c(e=>he(P.encode(JSON.stringify(e)).buffer).replace(/=/g,""),"encodeJwtPart"),Wt=c(e=>he(e).replace(/=/g,""),"encodeSignaturePart"),ye=c(e=>JSON.parse(ct.decode(de(e))),"decodeJwtPart");function pt(e){if(typeof e=="object"&&e!==null){let t=e;return"alg"in t&&Object.values(O).includes(t.alg)&&(!("typ"in t)||t.typ==="JWT")}return!1}c(pt,"isTokenHeader");var mt=c(async(e,t,r="HS256")=>{let s=Ee(e),n;typeof t=="object"&&"alg"in t?(r=t.alg,n=Ee({alg:r,typ:"JWT",kid:t.kid})):n=Ee({alg:r,typ:"JWT"});let i=`${n}.${s}`,o=await lt(t,r,P.encode(i)),u=Wt(o);return`${i}.${u}`},"sign"),Se=c(async(e,t,r)=>{if(!r)throw new pe;let{alg:s,iss:n,nbf:i=!0,exp:o=!0,iat:u=!0,aud:a}=typeof r=="string"?{alg:r}:r;if(!s)throw new pe;let l=e.split(".");if(l.length!==3)throw new $(e);let{header:h,payload:d}=ve(e);if(!pt(h))throw new we(h);if(h.alg!==s)throw new me(s,h.alg);let f=Math.floor(Date.now()/1e3);if(i&&d.nbf&&d.nbf>f)throw new Ze(e);if(o&&d.exp&&d.exp<=f)throw new et(e);if(u&&d.iat&&f<d.iat)throw new tt(f,d.iat);if(n){if(!d.iss)throw new Y(n,null);if(typeof n=="string"&&d.iss!==n)throw new Y(n,d.iss);if(n instanceof RegExp&&!n.test(d.iss))throw new Y(n,d.iss)}if(a){if(!d.aud)throw new ot(d);if(!(Array.isArray(d.aud)?d.aud:[d.aud]).some(m=>a instanceof RegExp?a.test(m):typeof a=="string"?m===a:Array.isArray(a)&&a.includes(m)))throw new at(a,d.aud)}let w=e.substring(0,e.lastIndexOf("."));if(!await dt(t,s,de(l[2]),P.encode(w)))throw new it(e);return d},"verify"),Bt=[O.HS256,O.HS384,O.HS512],wt=c(async(e,t,r)=>{let s=t.verification||{},n=qt(e);if(!pt(n))throw new we(n);if(!n.kid)throw new rt(n);if(Bt.includes(n.alg))throw new st(n.alg);if(!t.allowedAlgorithms.includes(n.alg))throw new nt(n.alg,t.allowedAlgorithms);let i=t.keys?[...t.keys]:void 0;if(t.jwks_uri){let u=await fetch(t.jwks_uri,r);if(!u.ok)throw new Error(`failed to fetch JWKS from ${t.jwks_uri}`);let a=await u.json();if(!a.keys)throw new Error('invalid JWKS response. "keys" field is missing');if(!Array.isArray(a.keys))throw new Error('invalid JWKS response. "keys" field is not an array');i??=[],i.push(...a.keys)}else if(!i)throw new Error('verifyWithJwks requires options for either "keys" or "jwks_uri" or both');let o=i.find(u=>u.kid===n.kid);if(!o)throw new $(e);if(o.alg&&o.alg!==n.alg)throw new me(o.alg,n.alg);return await Se(e,o,{alg:n.alg,...s})},"verifyWithJwks"),ve=c(e=>{try{let[t,r]=e.split("."),s=ye(t),n=ye(r);return{header:s,payload:n}}catch{throw new $(e)}},"decode"),qt=c(e=>{try{let[t]=e.split(".");return ye(t)}catch{throw new $(e)}},"decodeHeader");var L={sign:mt,verify:Se,decode:ve,verifyWithJwks:wt};var Ut=L.verifyWithJwks,Re=L.verify,Ft=L.decode,be=L.sign;var g=new le;g.use("/api/*",Qe());async function Ae(e){let t=new TextEncoder().encode(e),r=await crypto.subtle.digest("SHA-256",t);return Array.from(new Uint8Array(r)).map(n=>n.toString(16).padStart(2,"0")).join("")}c(Ae,"hashPassword");g.post("/api/login",async e=>{let{username:t,password:r}=await e.req.json(),s=await Ae(r),n=await e.env.DB.prepare("SELECT * FROM users WHERE username = ? AND password_hash = ?").bind(t,s).first();if(!n)return e.json({error:"Credenciales inv\xE1lidas"},401);let i={id:n.id,role:n.role,exp:Math.floor(Date.now()/1e3)+60*60*8},o=await be(i,e.env.JWT_SECRET);return e.json({token:o,user:{id:n.id,username:n.username,name:n.name,role:n.role}})});g.use("/api/*",async(e,t)=>{if(e.req.method==="OPTIONS"||e.req.path==="/api/login")return t();let r=e.req.header("Authorization");if(!r||!r.startsWith("Bearer "))return e.json({error:"No autorizado"},401);let s=r.split(" ")[1];try{let n=await Re(s,e.env.JWT_SECRET);e.set("user",n),await t()}catch(n){return e.json({error:"Token inv\xE1lido",details:n.message},401)}});g.get("/api/users",async e=>{if(e.get("user").role!=="DIRECTOR")return e.json({error:"Prohibido"},403);let{results:r}=await e.env.DB.prepare("SELECT id, name, username, role, created_at FROM users").all();return e.json(r)});g.post("/api/users",async e=>{if(e.get("user").role!=="DIRECTOR")return e.json({error:"Prohibido"},403);let{name:r,username:s,password:n,role:i}=await e.req.json(),o=crypto.randomUUID(),u=await Ae(n);return await e.env.DB.prepare("INSERT INTO users (id, name, username, password_hash, role) VALUES (?, ?, ?, ?, ?)").bind(o,r,s,u,i).run(),e.json({id:o,name:r,username:s,role:i},201)});g.put("/api/users/:id",async e=>{if(e.get("user").role!=="DIRECTOR")return e.json({error:"Prohibido"},403);let r=e.req.param("id"),{name:s,password:n,role:i}=await e.req.json();if(n){let o=await Ae(n);await e.env.DB.prepare("UPDATE users SET name = ?, password_hash = ?, role = ? WHERE id = ?").bind(s,o,i,r).run()}else await e.env.DB.prepare("UPDATE users SET name = ?, role = ? WHERE id = ?").bind(s,i,r).run();return e.json({success:!0})});g.delete("/api/users/:id",async e=>{if(e.get("user").role!=="DIRECTOR")return e.json({error:"Prohibido"},403);let r=e.req.param("id");return await e.env.DB.prepare("DELETE FROM users WHERE id = ?").bind(r).run(),e.json({success:!0})});g.get("/api/classes",async e=>{let t=e.get("user");if(t.role==="DIRECTOR"){let{results:r}=await e.env.DB.prepare("SELECT * FROM classes").all();return e.json(r)}else{let{results:r}=await e.env.DB.prepare("SELECT * FROM classes WHERE professor_id = ?").bind(t.id).all();return e.json(r)}});g.post("/api/classes",async e=>{if(e.get("user").role!=="DIRECTOR")return e.json({error:"Prohibido"},403);let{name:r,grade:s,professor_id:n}=await e.req.json(),i=crypto.randomUUID();return await e.env.DB.prepare("INSERT INTO classes (id, name, grade, professor_id) VALUES (?, ?, ?, ?)").bind(i,r,s,n).run(),e.json({id:i,name:r,grade:s,professor_id:n},201)});g.put("/api/classes/:id",async e=>{if(e.get("user").role!=="DIRECTOR")return e.json({error:"Prohibido"},403);let r=e.req.param("id"),{name:s,grade:n,professor_id:i}=await e.req.json();return await e.env.DB.prepare("UPDATE classes SET name = ?, grade = ?, professor_id = ? WHERE id = ?").bind(s,n,i,r).run(),e.json({success:!0})});g.delete("/api/classes/:id",async e=>{let t=e.get("user"),r=e.req.param("id");if(t.role==="PROFESSOR"){let s=await e.env.DB.prepare("SELECT professor_id FROM classes WHERE id = ?").bind(r).first();if(!s||s.professor_id!==t.id)return e.json({error:"Prohibido"},403)}return await e.env.DB.prepare("DELETE FROM classes WHERE id = ?").bind(r).run(),e.json({success:!0})});g.get("/api/students/:classId",async e=>{let t=e.get("user"),r=e.req.param("classId");if(t.role==="PROFESSOR"){let n=await e.env.DB.prepare("SELECT professor_id FROM classes WHERE id = ?").bind(r).first();if(!n||n.professor_id!==t.id)return e.json({error:"Prohibido"},403)}let{results:s}=await e.env.DB.prepare("SELECT * FROM students WHERE class_id = ?").bind(r).all();return e.json(s)});g.post("/api/students",async e=>{let t=e.get("user"),{name:r,class_id:s}=await e.req.json();if(t.role==="PROFESSOR"){let i=await e.env.DB.prepare("SELECT professor_id FROM classes WHERE id = ?").bind(s).first();if(!i||i.professor_id!==t.id)return e.json({error:"Prohibido"},403)}let n=crypto.randomUUID();return await e.env.DB.prepare("INSERT INTO students (id, name, class_id) VALUES (?, ?, ?)").bind(n,r,s).run(),e.json({id:n,name:r,class_id:s},201)});g.delete("/api/students/:id",async e=>{let t=e.get("user"),r=e.req.param("id");if(t.role==="PROFESSOR"){let s=await e.env.DB.prepare("SELECT class_id FROM students WHERE id = ?").bind(r).first();if(!s)return e.json({error:"Not Found"},404);let n=await e.env.DB.prepare("SELECT professor_id FROM classes WHERE id = ?").bind(s.class_id).first();if(!n||n.professor_id!==t.id)return e.json({error:"Prohibido"},403)}return await e.env.DB.prepare("DELETE FROM students WHERE id = ?").bind(r).run(),e.json({success:!0})});g.get("/api/attendance",async e=>{let t=e.req.query("classId"),r=e.req.query("date"),s=e.get("user");if(!t||!r)return e.json({error:"Faltan par\xE1metros classId o date"},400);if(s.role==="PROFESSOR"){let i=await e.env.DB.prepare("SELECT professor_id FROM classes WHERE id = ?").bind(t).first();if(!i||i.professor_id!==s.id)return e.json({error:"Prohibido"},403)}let{results:n}=await e.env.DB.prepare("SELECT * FROM attendance WHERE class_id = ? AND date = ?").bind(t,r).all();return e.json(n)});g.post("/api/attendance",async e=>{let t=e.get("user"),{class_id:r,date:s,records:n}=await e.req.json();if(t.role==="PROFESSOR"){let o=await e.env.DB.prepare("SELECT professor_id FROM classes WHERE id = ?").bind(r).first();if(!o||o.professor_id!==t.id)return e.json({error:"Prohibido"},403)}let i=n.map(o=>e.env.DB.prepare("INSERT OR REPLACE INTO attendance (id, student_id, class_id, date, status) VALUES (COALESCE((SELECT id FROM attendance WHERE class_id = ? AND student_id = ? AND date = ?), ?), ?, ?, ?, ?)").bind(r,o.student_id,s,crypto.randomUUID(),o.student_id,r,s,o.status));return await e.env.DB.batch(i),e.json({success:!0})});g.delete("/api/attendance/:classId/:date",async e=>{let t=e.get("user"),r=e.req.param("classId"),s=e.req.param("date");if(t.role==="PROFESSOR"){let n=await e.env.DB.prepare("SELECT professor_id FROM classes WHERE id = ?").bind(r).first();if(!n||n.professor_id!==t.id)return e.json({error:"Prohibido"},403)}return await e.env.DB.prepare("DELETE FROM attendance WHERE class_id = ? AND date = ?").bind(r,s).run(),e.json({success:!0})});g.get("/api/reports",async e=>{let t=e.req.query("from"),r=e.req.query("to"),s=e.get("user");if(!t||!r)return e.json({error:"Faltan fechas from o to"},400);let n="",i=[t,r];s.role==="PROFESSOR"&&(n="AND c.professor_id = ?",i.push(s.id));let o=`
    SELECT a.class_id, a.status, COUNT(*) as count, c.name as class_name
    FROM attendance a
    JOIN classes c ON a.class_id = c.id
    WHERE a.date >= ? AND a.date <= ? ${n}
    GROUP BY a.class_id, a.status
  `,{results:u}=await e.env.DB.prepare(o).bind(...i).all(),a=`
    SELECT s.id, s.name, a.class_id, c.name as class_name,
           SUM(CASE WHEN a.status = 'PRESENT' THEN 1 ELSE 0 END) as present,
           COUNT(*) as total
    FROM attendance a
    JOIN students s ON a.student_id = s.id
    JOIN classes c ON a.class_id = c.id
    WHERE a.date >= ? AND a.date <= ? ${n}
    GROUP BY s.id
    HAVING (CAST(SUM(CASE WHEN a.status = 'PRESENT' THEN 1 ELSE 0 END) AS FLOAT) / COUNT(*)) < 0.75
  `,{results:l}=await e.env.DB.prepare(a).bind(...i).all();return e.json({aggregation:u,riskStudents:l})});var Ln=g;export{Ln as default};
//# sourceMappingURL=index.js.map
